// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  //url = "postgresql://johndoe:mysecretpassword@localhost:5432"
}

model User {
  id              Int       @id @default(autoincrement())
  email           String    @unique
  name            String
  password        String
  type            Role
  allowedProjects Project[]
}

model Project {
  id           Int                 @id @default(autoincrement())
  name         String              @unique
  apiKeys      ApiKey[]
  users        User[]
  emailService EmailServiceConfig?
  fileService  FileServiceConfig?
}

model ApiKey {
  id          Int        @id @default(autoincrement())
  hash        String     @unique
  scopes      ApiScope[]
  description String
  projectId   Int
  project     Project    @relation(fields: [projectId], references: [id])
  environment String
}

enum ApiScope {
  FULL
}

enum Role {
  SUPERADMIN
  ADMIN
  USER
}

model EmailServiceConfig {
  id      Int                           @id
  emails  EmailServiceConfigAndSender[]
  domains EmailDomain[]
  Project Project                       @relation(fields: [id], references: [id])
}

model EmailServiceConfigAndSender {
  config   EmailServiceConfig @relation(fields: [configId], references: [id])
  configId Int // relation scalar field (used in the `@relation` attribute above)
  sender   EmailSender        @relation(fields: [username, domain], references: [username, domain])
  username String
  domain   String

  @@id([configId, username, domain])
}

model EmailSender {
  username        String
  domain          String
  domainItem      EmailDomain                   @relation(fields: [domain], references: [domain])
  description     String? // Optional metadata/description field
  attachedConfigs EmailServiceConfigAndSender[]

  @@id([username, domain])
}

model EmailDomain {
  domain          String               @id()
  subdomain       String
  sendgridId      Int
  attachedConfigs EmailServiceConfig[]
  EmailSender     EmailSender[]
}

model FileServiceConfig {
  id              Int                 @id
  buckets         FileServiceBucket[]
  Project         Project             @relation(fields: [id], references: [id])
  FileServiceFile FileServiceFile[]
}

model FileProvider {
  name              String              @id
  accessKey         String
  metadata          String
  FileServiceBucket FileServiceBucket[]
}

model FileServiceBucket {
  name             String
  provider         FileProvider      @relation(fields: [fileProviderName], references: [name])
  configId         Int
  config           FileServiceConfig @relation(fields: [configId], references: [id])
  fileProviderName String
  FileServiceFile  FileServiceFile[]

  @@id([name, configId])
}

model FileServiceFile {
  path       String
  bucket     FileServiceBucket @relation(fields: [bucketName, configId], references: [name, configId])
  config     FileServiceConfig @relation(fields: [configId], references: [id])
  configId   Int
  bucketName String

  @@id([path, bucketName, configId])
}
